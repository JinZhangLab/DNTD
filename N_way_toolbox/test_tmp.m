clc;clear;close all;
x=1:100;
A0=[.1 .2 .3 .4 .5;
    .1 .2 .3 .2 .1;
    .1 .3 .1 .3 .1]';
B0=[10 20 30 40;
    10 20  25 28;
    10 12 20 38]';
C1=[gaussmf(x,[3,20]);
    gaussmf(x,[3,40]);
    gaussmf(x,[3,80])]';
C2=[gaussmf(x,[3,25]);
    gaussmf(x,[3,45]);
    gaussmf(x,[3,85])]';
C3=[gaussmf(x,[3,28]);
    gaussmf(x,[3,48]);
    gaussmf(x,[3,88])]';
C4=[gaussmf(x,[3,29]);
    gaussmf(x,[3,49]);
    gaussmf(x,[3,89])]';
X1=[A0*diag(B0(1,:))*C1'];
X2=[A0*diag(B0(2,:))*C2'];
X3=[A0*diag(B0(3,:))*C3'];
X4=[A0*diag(B0(4,:))*C4'];

XXX(:,:,1)=X1;
XXX(:,:,2)=X2;
XXX(:,:,3)=X3;
XXX(:,:,4)=X4;
[Factors,it,err,Corcondia] = parafac(XXX,3);
[A,H,C,P,fit]=parafac2(XXX,3);
figure;plot(P{1}*H,'r');hold on;
plot(P{2}*H,'g');
plot(P{3}*H,'b');
plot(P{4}*H,'k');